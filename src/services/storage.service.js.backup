const logger = require('../utils/logger')
const { NotFoundError, BadRequestError } = require('../errors/client.error')
const { InventoryRepository } = require('../repositories')

const CONTEXT = 'StorageService'

class StorageService {
  constructor(StorageRepository, ProductRepository) {
    this.StorageRepository = StorageRepository
    this.ProductRepository = ProductRepository
  }

  async createStorageLocation(storageDetails) {
    logger.info(`[${CONTEXT}] Creating new storage location with details: ${JSON.stringify(storageDetails)}`)
    const { length, width, height } = storageDetails.dimensions
    storageDetails.Volume = length * width * height
    
    const storage = await this.StorageRepository.createStorageLocation(storageDetails)
    if (storageDetails.inventory) {
      const inventoryRepo = new InventoryRepository()
      await inventoryRepo.addStorageToInventory(storageDetails.inventory, storage._id)
    }
    
    logger.info(`[${CONTEXT}] Storage location created successfully: ${storage._id}`)
    return storage
  }

  async getStorage(identifier) {
    logger.info(`[${CONTEXT}] Fetching storage with identifier: ${JSON.stringify(identifier)}`)
    let storage
    if (identifier.storageId) {
      storage = await this.StorageRepository.getStorageById(identifier.storageId)
    } else if (identifier.locationId) {
      storage = await this.StorageRepository.getStorageByLocationId(identifier.locationId)
    }

    if (!storage) {
      logger.warn(`[${CONTEXT}] Storage not found with identifier: ${JSON.stringify(identifier)}`)
      throw new NotFoundError('Storage location not found')
    }

    logger.info(`[${CONTEXT}] Fetched storage successfully: ${storage._id}`)
    return storage
  }

  async getAllStorages() {
    logger.info(`[${CONTEXT}] Fetching all storage locations`)
    const storages = await this.StorageRepository.getAllStorages()
    logger.info(`[${CONTEXT}] Fetched all storage locations successfully. Count: ${storages.length}`)
    return storages
  }

  async updateStorage(storageId, storageDetails) {
    logger.info(`[${CONTEXT}] Updating storage location: ${storageId}`)
    if (storageDetails.dimensions) {
        const { length, width, height } = storageDetails.dimensions
        storageDetails.Volume = length * width * height
    }
    const updatedStorage = await this.StorageRepository.updateStorage(storageId, storageDetails)
    if (!updatedStorage) {
      throw new NotFoundError('Storage location not found')
    }
    logger.info(`[${CONTEXT}] Storage location updated successfully: ${storageId}`)
    return updatedStorage
  }

  async deleteStorage(storageId) {
    logger.info(`[${CONTEXT}] Deleting storage location: ${storageId}`)
    const storage = await this.StorageRepository.getStorageById(storageId)
    if (!storage) {
        throw new NotFoundError('Storage location not found')
    }
    if (storage.products.length > 0) {
        throw new BadRequestError('Cannot delete storage location with products inside.')
    }
    const deletedStorage = await this.StorageRepository.deleteStorage(storageId)
    logger.info(`[${CONTEXT}] Storage location deleted successfully: ${storageId}`)
    return deletedStorage
  }

  async addProductToStorage(storageId, productId, quantity = 1, inventoryId = null) {
    logger.info(`[${CONTEXT}] Adding ${quantity} pieces of product ${productId} to storage ${storageId}`)
    const product = await this.ProductRepository.getProductById(productId)
    if (!product) {
      throw new NotFoundError('Product not found')
    }

    const storage = await this.StorageRepository.getStorageById(storageId)
    if (!storage) {
      throw new NotFoundError('Storage location not found')
    }

    // Calculate totals based on quantity
    const productVolume = ((product.dimensions?.length * product.dimensions?.width * product.dimensions?.height) || 0) * quantity
    const productWeight = (product.weight || 0) * quantity
    const productCost = (product.price || 0) * quantity

    // Validate capacity constraints
    if (storage.capacityOccupied + productWeight > storage.holdingCapacity) {
      throw new BadRequestError(`Product weight (${productWeight}) exceeds available storage capacity (${storage.holdingCapacity - storage.capacityOccupied})`)
    }
    if (storage.VolumeOccupied + productVolume > storage.Volume) {
      throw new BadRequestError(`Product volume (${productVolume}) exceeds available storage volume (${storage.Volume - storage.VolumeOccupied})`)
    }

    // Validate stock availability
    if (product.quantity < quantity) {
      throw new BadRequestError(`Insufficient stock. Available: ${product.quantity}, Requested: ${quantity}`)
    }
      throw new BadRequestError('Product volume exceeds storage capacity - too big for this storage!')
    }

    const targetInventoryId = inventoryId || storage.inventory
    if (!targetInventoryId) {
      throw new BadRequestError('No inventory specified for this storage location')
    }

    if (!inventoryId) {
      const inventoryRepo = new InventoryRepository()
      
      const inventory = await inventoryRepo.getInventoryById(targetInventoryId)
      if (!inventory) {
        throw new NotFoundError('Inventory not found')
      }

      if (inventory.capacityOccupied + productWeight > inventory.totalCapacity)
      throw new BadRequestError('Product weight exceeds inventory capacity - too heavy!')
      if (inventory.volumeOccupied + productVolume > inventory.totalVolume)
      throw new BadRequestError('Product volume exceeds inventory capacity - too big!')

      await inventoryRepo.addProductToInventory(targetInventoryId, productId)
      await inventoryRepo.updateInventory(targetInventoryId, { 
        $inc: { 
          capacityOccupied: productWeight,
          volumeOccupied: productVolume,
          costPrice: productCost
        } 
      })

      await this.ProductRepository.updateProduct(productId, { storage: storageId })
    }

    const updatedStorage = await this.StorageRepository.addProductToStorage(storageId, productId)
    
    await this.StorageRepository.updateStorage(storageId, {
      $inc: { 
        capacityOccupied: productWeight,
        VolumeOccupied: productVolume,
        totalCost: productCost
      }
    })

    logger.info(`[${CONTEXT}] Product ${productId} added to storage ${storageId} successfully. Cost: ${productCost}`)
    return updatedStorage
  }

  async removeProductFromStorage(storageId, productId, inventoryId = null) {
    logger.info(`[${CONTEXT}] Removing product ${productId} from storage ${storageId}`)
    const product = await this.ProductRepository.getProductById(productId)
    if (!product) {
      throw new NotFoundError('Product not found')
    }

    const productVolume = (product.dimensions?.length * product.dimensions?.width * product.dimensions?.height) || 0
    const productWeight = product.weight || 0
    const productCost = (product.price || 0) * (product.quantity || 1)

    if (!inventoryId) {
      const storage = await this.StorageRepository.getStorageById(storageId)
      if (storage && storage.inventory) {
        const inventoryRepo = new InventoryRepository()
        await inventoryRepo.removeProductFromInventory(storage.inventory, productId)
        await inventoryRepo.updateInventory(storage.inventory, { 
          $inc: { 
            capacityOccupied: -productWeight,
            volumeOccupied: -productVolume,
            costPrice: -productCost
          } 
        })

        await this.ProductRepository.updateProduct(productId, { $unset: { storage: "" } })
      }
    }

    const updatedStorage = await this.StorageRepository.removeProductFromStorage(storageId, productId)
    
    await this.StorageRepository.updateStorage(storageId, {
      $inc: { 
        capacityOccupied: -productWeight,
        VolumeOccupied: -productVolume,
        totalCost: -productCost
      }
    })

    logger.info(`[${CONTEXT}] Product ${productId} removed from storage ${storageId} successfully. Cost deducted: ${productCost}`)
    return updatedStorage
  }

  async getStorageUtilization(storageId) {
    logger.info(`[${CONTEXT}] Calculating utilization for storage: ${storageId}`)
    const result = await this.StorageRepository.getStorageUtilization(storageId)
    logger.info(`[${CONTEXT}] Storage ${storageId} - Capacity: ${result.capacityUtilization}, Volume: ${result.volumeUtilization}, Total Cost: $${result.totalCost}`)
    return result
  }

  async getStorageCostSummary(storageId) {
    logger.info(`[${CONTEXT}] Getting cost summary for storage: ${storageId}`)
    const utilization = await this.getStorageUtilization(storageId)
    
    const costSummary = {
      totalStorageValue: utilization.totalCost,
      capacityUtilization: utilization.capacityUtilization,
      volumeUtilization: utilization.volumeUtilization,
      summary: {
        holdingCapacity: utilization.holdingCapacity,
        capacityUsed: utilization.capacityOccupied,
        totalVolume: utilization.totalVolume,
        volumeUsed: utilization.volumeOccupied,
        totalValue: utilization.totalCost
      }
    }
    
    logger.info(`[${CONTEXT}] Storage cost summary calculated for storage: ${storageId}`)
    return costSummary
  }
}

module.exports = StorageService
